@model OCTWEB_NET45.Models.ManageWSListModel
@using PagedList.Mvc
@{
    ViewBag.Title = "CourseWSList";
    Layout = "~/Views/Shared/_Layout.cshtml";
    @Styles.Render("~/Content/css/ModifyTrainingMainList.css")
}


<div class="container-fluid">
    <div class="row">
        <a href="/TrainingCourseManagement/CourseReport" class="btn-outline-secondary"><i class="fa fa-angle-left"></i> Training Course Reports </a>&nbsp;
    </div>
    <div class="row">
        <div class="container-fluid">
            @using (Html.BeginForm("CourseWSList", "TrainingCourseReport", FormMethod.Post, new { @class = "form-horizontal", role = "form", @id = "Form1" }))
            {
                <div class="card">
                    <div class="card-header">
                        <div class="row justify-content-center">
                            <div class="col">
                                <h4 class="page-title ">Training Course WS <span style="color:green;">Report</span></h4>
                                <p class="text-success">@ViewBag.Message</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="form-row justify-content-center">
                            <div class="col">
                            <fieldset>
                                <div class="form-row justify-content-center">
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Status: </label>
                                            @Html.DropDownList("selected_status", Model.SelectStatusId, "All", new { @class = "form-control form-control-sm", style = "width:100%" })
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>WS Number: </label>
                                            @Html.TextBoxFor(m => m.search_wsnumber, new { @class = "form-control form-control-sm" })
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Area: </label>
                                            @Html.TextBoxFor(m => m.search_area, new { @class = "form-control form-control-sm" })
                                        </div>
                                    </div>
                                    <div class="col-md-6 align-self-end">
                                        <div class="form-group">
                                            <button type="submit" name="SearchBtn" id="SearchBtn" value="Search" class="btn btn-sm btn-success">
                                                <i class="fas fa-search"></i> Search
                                            </button>
                                            <button type="button" id="ExportToCsvBtn" name="ExportToCsvBtn" class="btn btn-sm btn-outline-primary" value="null">
                                                <i class="fas fa-download"></i> Export
                                            </button>
                                            <input hidden="hidden" id="ExportToCsv" name="ExportToCsv" value="null" />

                                            <button id="clear" type="button" name="clear" class="btn btn-sm btn-outline-dark">
                                                <i class="fas fa-eraser"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    </div>
                </div>
                
                <br />
                <div class="form-row">
                    @foreach (var item in Model.Emp_TrainingWsHeaderModelPagedList.Select((value, i) => new { i, value }))
                    {
                        var status_style_head = "";
                        if (item.value.status > 0)
                        {
                            status_style_head = "background: #6D7B8D";

                        }
                        else
                        {
                            status_style_head = "background:#922b21";
                        }

                        <div class="courses-container">
                            <div class="course">
                                <div class="course-row">
                                    <div class="course-preview" style="@status_style_head">
                                        <p class="rev">Rev : @item.value.Train_Min</p> 
                                        <p class="trainname">@item.value.Train_Name </p> 
                                        
                                        @if (item.value.status > 0)
                                        {
                                            <a style="cursor:pointer;" onclick="DataTable('TrainingDate-@item.value.Id')"> vie all chapters <i class="fas fa-chevron-right"></i></a>
                                        }

                                    </div>
                                    <div class="course-info">
                                        <p style="color:black">
                                            <span style="font-weight:bold">Topic : </span> @item.value.CourseHeader <br />
                                            <span style="font-weight:bold">Department : </span> @item.value.Train_WS_Temp <br />
                                            <span style="font-weight:bold">Date of WS : </span> @item.value.Train_DateWS <br />
                                            <span style="font-weight:bold">Location : </span> @item.value.Train_Location <br />
                                            @*<span style="font-weight:bold">TrainingWSHeader ID : </span> @item.value.Id*@
                                        </p>
                                    </div>
                                </div>
                                <div class="course-trainingDate">
                                    <div class="TrainingDate" id="TrainingDate-@item.value.Id">
                                        @foreach (var date in Model.TrainingDate.Where(x => x.E_TrainWsHeader_Id == item.value.Id).OrderByDescending(x => x.Id).Select((value, i) => new { i, value }))
                                        {
                                            <div class="test-all-g">
                                                <i class='fas fa-angle-right'></i>
                                                <a class="text-dark" style="cursor:pointer" onclick="emptable('emplist-@date.value.Id')">Training Date @date.value.Training_dateSt - @date.value.Training_dateEnd </a>
                                            </div>

                                            // ตรวจสอบว่า TraineeLists มีข้อมูลสำหรับ date.value.Id หรือไม่
                                            var traineeListForDate = Model.TraineeLists.Where(x => x.e_trainWsdate_id == date.value.Id).ToList();

                                            // ตรวจสอบว่ามีข้อมูลที่กรองแล้วหรือไม่
                                            var hasTrainees = traineeListForDate.Any();

                                            // คำนวณผลรวมของ assessment และจำนวนของผู้เข้าร่วม
                                            int totalAssessment = traineeListForDate.Sum(x => x.assessment);
                                            int totalCount = traineeListForDate.Count();
                                            int averageAssessment = totalCount > 0 ? (totalAssessment * 100) / (totalCount * 3) : 0;

                                            if (hasTrainees)
                                            {
                                                <div class="table-emplist" id="emplist-@date.value.Id">
                                                    <table class="styled-table">
                                                        <caption>
                                                            เวลา @date.value.Trai_Times:@date.value.Trai_Timess ถึง @date.value.Trai_TimendT:@date.value.Trai_TimendTs  เป็นจำนวนเวลาทั้งหมด : @date.value.Train_Hour H @date.value.Train_Min M   ความเข้าใจในการอบรมคิดเป็น : @averageAssessment  %
                                                        </caption>
                                                        <thead>
                                                            @if (@Model.TraineeLists.Any())
                                                            {
                                                                <tr>
                                                                    <th style="text-align:center; width:8%">Items</th>
                                                                    <th style="text-align:center">Emp Id</th>
                                                                    <th style="text-align:center">First Name</th>
                                                                    <th style="text-align:center">Last Name</th>
                                                                    <th style="text-align:center">Nation</th>
                                                                    <th style="text-align:center">Department</th>
                                                                    <th style="text-align:center">Position</th>
                                                                    <th style="text-align:center">Assessment</th>

                                                                </tr>
                                                            }
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var EmpList_Train in Model.TraineeLists.Where(x => x.e_trainWsdate_id == date.value.Id).Select((value, i) => new { i, value }))
                                                            {
                                                                <tr>
                                                                    <td style="text-align:center">@(EmpList_Train.i + 1)</td>
                                                                    <td style="text-align:center">@EmpList_Train.value.emp_id</td>
                                                                    <td style="text-align:center">@EmpList_Train.value.fname</td>
                                                                    <td style="text-align:center">@EmpList_Train.value.lname</td>
                                                                    <td style="text-align:center">@EmpList_Train.value.nation</td>
                                                                    <td style="text-align:center">@EmpList_Train.value.dept</td>
                                                                    <td style="text-align:center">@EmpList_Train.value.position</td>
                                                                    <td style="text-align:center">
                                                                        @{
                                                                            var assessment = EmpList_Train.value.assessment;
                                                                            string showtext = assessment >= 3 ? "Pass (ผ่าน)" : "No Pass (ไม่ผ่าน)";
                                                                        }
                                                                        <p>@showtext</p>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }



                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            <div class="row justify-content-center">
                Page @(Model.Emp_TrainingWsHeaderModelPagedList.PageCount < Model.Emp_TrainingWsHeaderModelPagedList.PageNumber ? 0 : Model.Emp_TrainingWsHeaderModelPagedList.PageNumber) of @Model.Emp_TrainingWsHeaderModelPagedList.PageCount
            </div>
            <div class="row justify-content-center">
                @Html.PagedListPager(Model.Emp_TrainingWsHeaderModelPagedList, page => Url.Action("CourseWSList", new RouteValueDictionary()
            {
                {"Page",page},
                {"search_area",Model.search_area},
                {"search_wsnumber",Model.search_wsnumber},
                {"selected_status",Model.selected_status},

            }))
            </div>
        </div>
    </div>
</div>




<script language="JavaScript">
    $(document).on('select2:open', function (e) {
        const selectId = e.target.id;
        $(".select2-search__field[aria-controls='select2-" + selectId + "-results']").each(function (key, value) {
            value.focus();
        });
    });

    $(document).ready(function () {
        /*
        $("#selected_status").select2({
            placeholder: "All",
            allowClear: true,
            width: 'resolve'
        });*/

        $("#search_wsnumber").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/TrainingCourseReport/GetWSTrainName",
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return item;
                        }))
                    }
                })
            },
            messages: {
                noResults: 'No results found.',
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            },
        });

        $("#search_area").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/TrainingCourseReport/GetWSTrainArea",
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return item;
                        }))
                    }
                })
            },
            messages: {
                noResults: 'No results found.',
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            },
        });

    });
    /*
    $("body").on("change", "#selected_status", function () {
        document.forms["Form1"].submit();
        if ($('#selected_status').val()) {

        }
    });
    */
    $("#SearchBtn").click(function () {
        $("#ExportToCsv").val("");
        document.forms["Form1"].submit();
    })

    $("#ExportToCsvBtn").click(function () {
        $("#ExportToCsv").val("ExportToCsv");
        document.forms["Form1"].submit();
    })

    $("#clear").click(function () {
        $('#selected_status').val(null).trigger('change');
        $('#search_wsnumber').val(null).trigger('change');
        $('#search_area').val(null).trigger('change');
    });

    //---------------------------------------------------------
    function DataTable(id) {
        var element = document.getElementById(id);
        if (element.style.display == "none" || element.style.display == "") {
            element.style.display = "block";
        }
        else {
            element.style.display = "none"
        }
    }

    function emptable(tableId) {
        var table = document.getElementById(tableId);
        if (table.style.display === "none" || table.style.display === "") {
            table.style.display = "block";
        } else {
            table.style.display = "none";
        }
    }


</script>

