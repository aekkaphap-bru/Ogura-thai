@model OCTWEB_NET45.Models.CommonItemListModel

<style>
    #table1 td.details-control {
        background: url('../static/img/arrow-right.png') no-repeat center center;
        background-repeat: no-repeat;
        background-size: 30px 30px;
        
        cursor: pointer;
        /*background:linear-gradient(to right top, #f9f8de, #eefbe3, #e4fdea, #dcfff3, #d8fffd); */
    }

    #table1 tr.details td.details-control {
        background: #5b6672 url('../static/img/minus-circle-solid.svg') no-repeat center center;
        background-repeat: no-repeat;
        background-size: 15px 15px;
    }
</style>

<div class="modal-header" style=" background: linear-gradient(to right, #123456, #2d445f, #445568, #5b6672, #73777b);">
    <div class="form-group row">
        <h5 class="modal-title" id="myModalLabel" style="color:white;">
            <span style="color:yellow">Item No:</span> @Model.item_no,
            &nbsp; <span style="color:yellow">Model No:</span> @Model.model_no,
            &nbsp; <span style="color:yellow">Item Short Name:</span> @Model.item_short_name
        </h5>
    </div>
</div>

<div class="modal-body">
    <div class="container">
        <div class="form-row">
            <div class="col">
                <p class="text-danger">@ViewBag.ErrorMessage</p>
                <p class="text-success">@ViewBag.Message</p>
                <h4 class="font-weight-bolder my-1 text-center"><i class="fas fa-arrow-right" style="color: #ffc107"></i> Common Forward List </h4>
            </div>
        </div>
        <div class="form-row" style="box-shadow: initial;">
            <div class="col">
                <table class="table table-bordered table-striped" id="table1" style="font-size: 12px; width: 100%; background: linear-gradient(to right top, #f9f8de, #eefbe3, #e4fdea, #dcfff3, #d8fffd);">
                    <thead style="background: linear-gradient(to right top, #f9f8de, #eefbe3, #e4fdea, #dcfff3, #d8fffd);">
                        <tr>
                            <th width="5%" class="text-center"></th>
                            <th width="5%" class="text-center"></th>
                            <th width="10%" class="text-left">ItemNo</th>
                            <th width="12%" class="text-left">ModelNo</th>
                            <th width="12%" class="text-left">ItemShortName</th>
                            <th width=3% class="text-left">VendorCode</th>
                            <th width=8% class="text-left">VendorName</th>
                            <th width=3% class="text-left">Unit</th>
                            <th width=5% class="text-left">Max</th>
                            <th width=5% class="text-left">Min</th>
                            <th width=5% class="text-left">Avg</th>
                            <th width="7%" class="text-left">StockQty</th>
                            <th width="20%" class="text-left">Remark</th>
                        </tr>
                        <tr >
                            <th width="5%" class="text-center" style="vertical-align:middle"></th>
                            <th width="5%" class="text-center" style="vertical-align:middle"></th>
                            <th width="10%" class="text-left" style="vertical-align:middle">@Model.item_no</th>
                            <th width="12%" class="text-left" style="vertical-align:middle">@Model.model_no</th>
                            <th width="12%" class="text-left" style="vertical-align:middle">@Model.item_short_name</th>
                            <th width=3% class="text-left" style="vertical-align:middle">@Model.VendorCode</th>
                            <th width=8% class="text-left" style="vertical-align:middle">@Model.BusinessPartnerShortName</th>
                            <th width=3% class="text-left" style="vertical-align:middle">@Model.UnitCode</th>
                            <th width=5% class="text-right" style="vertical-align:middle">@Model.qty_max_str</th>
                            <th width=5% class="text-right" style="vertical-align:middle">@Model.qty_max_str</th>
                            <th width=5% class="text-right" style="vertical-align:middle">@Model.qty_avg_str</th>
                            @if (Model.qty_avg >= Model.StockQty)
                            {
                                <th width="7%" class="text-right" style="color: red; vertical-align: middle">@Model.StockQty_str</th>
                            }
                            else
                            {
                                <th width="7%" class="text-right" style="vertical-align:middle">@Model.StockQty_str</th>
                            }
                            <th width="20%" class="text-left" style="vertical-align:middle">@Model.LocationRemark</th>
                        </tr>
                    </thead>
                    <!--
                        <tbody>
                            foreach (var item in Model.ItemList.Select((value, i) => new { i,value}))
                            {
                                <tr>
                                    <td>item.i</td>
                                    <td>item.value.ItemNo</td>
                                    <td>item.value.ModelNo</td>
                                    <td>item.value.ItemShortName</td>
                                    <td>item.value.UnitCode</td>
                                    <td class="text-right">item.value.StockQty_str</td>
                                    <td@item.value.LocationRemark</td>
                                </tr>
                            }
                        </tbody>
                        -->
                </table>
            </div>
           
        </div>

    </div>
  
</div>
<div class="model-footer">
    <div class="row">
        <div class="col text-center">
            <a href="@Url.Action(actionName: "ExportCommon"
                         , controllerName: "StockItems", routeValues: new {id = @Model.child_id })"
               class="btn btn-sm btn-info">
                <i class="fas fa-download"></i> Export to Excel
            </a>
        </div>
    </div>
    <div class="row">
        <div class="col text-right">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
    </div>
</div>
<script language="JavaScript">
  /*
    $("#table1 tbody tr").click(function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        }
        else {
            $(this).addClass('selected');
        }
    });
    */
 
    $(document).ready(function () {
        var dt = $("#table1").DataTable({
            "data": @Html.Raw(Json.Encode(Model.ItemList)),
            "columns":[
                    {
                        class: 'details-control',
                        orderable: false,
                        data: null,
                        defaultContent: '',
                        "autowidth": true,
                    },
                     { "data": "id"
                        , "render": function(data,type,row){
                            return '<div><a href="/StockItems/ExportCommon?id='+data+'"class="btn btn-sm btn-info"><i class="fas fa-download"></i></a></div>';
                        }
                     },                  
                    { "data": "ItemNo", "autowidth": true },
                    { "data": "ModelNo", "autowidth": true },
                    { "data": "ItemShortName", "autowidth": true },
                    { "data": "VendorCode", "autowidth": true },
                    { "data": "BusinessPartnerShortName", "autowidth": true },
                    { "data": "UnitCode", "autowidth": true },
                    { "data": "qty_max_str", "autowidth": true },
                    { "data": "qty_min_str", "autowidth": true },
                    { "data": "qty_avg_str", "autowidth": true },
                    { "data": "StockQty_str", "autowidth": true },
                    { "data": "LocationRemark", "autowidth": true },

            ],
            createdRow: function(row, data, index){
                //$('td:eq(1)', row).css('background','linear-gradient(to right bottom, #95f9c5, #82f3c7, #6eedca, #59e7cd, #40e0d0)')
                //$('td', row).css('background','#B9EED2')
                $('td', row).css('vertical-align', 'middle');
                $('td:eq(11)', row).css('font-weight', 'bold');

                if(data["qty_avg"] >= data["StockQty"])
                {
                    // $('td:eq(10)', row).css('color', 'red');
                    // $('td:eq(9)', row).css('color', 'red');
                    // $('td:eq(8)', row).css('color', 'red');
                    // $('td:eq(7)', row).css('color', 'red');
                    $('td:eq(11)', row).css('color', 'red');
                }

            },
            searching: false,
            paging: false,
            ordering: false,
            info: false,
            //select: true,
            //buttons: [],
            //"pageLength": 50,
            //"lengthMenu": [[10,20,30,50,-1],[10,20,30,50,"All"]],
            columnDefs: [ {sortable: false,targets: 0 } ,
                          {sortable: false,targets: 1 } ,
                           {targets: 7 ,className:"text-right"} ,
                          {targets: 8 ,className:"text-right"} ,
                          {targets: 9 ,className:"text-right"} ,
                          {targets: 10 ,className:"text-right"} ,
                          {targets: 11 ,className:"text-right"} ,
                        
            ],
            //order: [[ 3, 'asc' ]],
            fixedColumns: true
        })

        function getDetail(id){
            return $.ajax({
                url: "/StockItems/GetCommonForwardJson",
                type: "get",
                data: { id: id},
                async: false,
            });
        }

        function format(d)
        {
            var html = "";
            var id = d.id;

            var request = getDetail(id);

            request.done(function( response ) {
                html += '<table style="font-size:12px; width:100%;  background: linear-gradient(to bottom, #f5ffc9, #ebfcc0, #e1f9b8, #d5f7b1, #c9f4aa);">'
                        +'<tr >'
                        +'<th width=10%>No.</th>'
                        +'<th width=10%>ItemNo</th>'
                        +'<th width=12%>ModelNo</th>'
                        +'<th width=12%>ItemShortName</th>'
                        +'<th width=3%>VendorCode</th>'
                        +'<th width=8%>VendorName</th>'
                        +'<th width=3%>Unit</th>'
                        +'<th width=5%>Max</th>'
                        +'<th width=5%>Min</th>'
                        +'<th width=5%>Avg</th>'
                        +'<th width=7%>StockQty</th>'
                        +'<th width=20%>Remark</th>'
                        +'<tr>'
                for (var i = 0; i < response.length; i++) {
                    if(response[i].status === 1){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    else if(response[i].status === 2){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    else if(response[i].status === 3){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    else if(response[i].status === 4){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 5){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #b9f3e4, #caf5dd, #dcf6da, #ecf7da, #f9f8de);">';
                    }
                    else if(response[i].status === 6){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #b9f3e4, #caf5dd, #dcf6da, #ecf7da, #f9f8de);">';
                    }
                    else if(response[i].status === 7){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #b9f3e4, #caf5dd, #dcf6da, #ecf7da, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 8){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #c9f4aa, #daf4b4, #e7f5c1, #f2f6cf, #f9f8de);">';
                    }
                    else if(response[i].status === 9){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #c9f4aa, #daf4b4, #e7f5c1, #f2f6cf, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 10){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #c9f4aa, #daf4b4, #e7f5c1, #f2f6cf, #f9f8de);">';
                    }
                    else if(response[i].status === 11){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #f1f7b5, #f4f7bf, #f6f7c9, #f8f8d4, #f9f8de);">';
                    }
                    else if(response[i].status === 12){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #f1f7b5, #f4f7bf, #f6f7c9, #f8f8d4, #f9f8de);">';
                    }
                    else if(response[i].status === 15){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #f1f7b5, #f4f7bf, #f6f7c9, #f8f8d4, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 13){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #ffd1d1, #ffdace, #ffe4cf, #fdeed5, #f9f8de);">';
                    }
                    else if(response[i].status === 14){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #ffd1d1, #ffdace, #ffe4cf, #fdeed5, #f9f8de);">';
                    }
                    else{
                        html += '<tr>';
                    }

                    html += '<td style="vertical-align:middle;">' + (i+1) + '</td>';

                    html += '<td style="vertical-align:middle;">' + response[i].ItemNo + '</td>';

                    html += '<td style="vertical-align:middle;">' + response[i].ModelNo + '</td>';
                    html += '<td style="vertical-align:middle;">' + response[i].ItemShortName + '</td>';
                    html += '<td style="vertical-align:middle;">' + response[i].VendorCode + '</td>';
                    html += '<td style="vertical-align:middle;">' + response[i].BusinessPartnerShortName + '</td>';
                    html += '<td style="vertical-align:middle;">' + response[i].UnitCode + '</td>';
                    html += '<td class="text-right" style="vertical-align:middle;">' + response[i].qty_max_str + '</td>';
                    html += '<td class="text-right" style="vertical-align:middle;">' + response[i].qty_min_str + '</td>';
                    html += '<td class="text-right" style="vertical-align:middle;">' + response[i].qty_avg_str + '</td>';

                    if(response[i].qty_avg >= response[i].StockQty)
                    {
                        html += '<td class="text-right" style="font-weight:bold; color:red; vertical-align:middle;">' + response[i].StockQty_str + '</td>';
                    }
                    else{
                        html += '<td class="text-right" style="font-weight:bold; vertical-align:middle;">' + response[i].StockQty_str + '</td>';
                    }
                  
                    html += '<td style="vertical-align:middle;" >' + response[i].LocationRemark + '</td>';

                    html += '</tr>';
                }
                html += '</table>'
            });

            return html;

        }

        //Array to track the ids of the details displayed rows
        var detailRows = [];
        $('#table1 tbody').on('click', 'tr td.details-control',function(){
            var tr = $(this).closest('tr');
            var row = dt.row(tr);
            var idx = detailRows.indexOf(tr.attr('id'));

            if(row.child.isShown()){
                tr.removeClass('details');
                row.child.hide();
                //Remove form the 'open' array
                detailRows.splice(idx,1);
            }else{
                tr.addClass('details');
                row.child(format(row.data())).show();
                //Add to the 'open' array
                if(idx === -1){
                    detailRows.push(tr.attr('id'));
                }
            }
        })

        //On each draw, loop over ther 'detailRows' array and show any
        dt.on('draw', function(){
            detailRows.forEach(function(id,i){
                $('#'+ id + 'td.details-control').trigger('click');
            });

        });

    });

    function getCommon(id)
    {
        debugger;
        //var $buttonClicked = $(this);
        var id = id;//$buttonClicked.attr('data-id');
        var options = { "backdrop": "static", keyboard: true };
        $.ajax({
            type: "GET",
            url: "/StockItems/GetCommon",
            contentType: "application/json; charset=utf-8",
            data: { "id": id },
            datatype: "json",
            success: function (data) {
                debugger;
                $('#getCommonModalContent').html(data);
                $('#getCommonModal').modal(options);
                $('#getCommonModal').modal('show');

            },
            error: function () {
                alert("Get common content load failed.");
            }
        });
    }

    function getCommonBack(id)
    {
        debugger;
        //var $buttonClicked = $(this);
        var id = id;//$buttonClicked.attr('data-id');
        var options = { "backdrop": "static", keyboard: true };
        $.ajax({
            type: "GET",
            url: "/StockItems/GetCommonBack",
            contentType: "application/json; charset=utf-8",
            data: { "id": id },
            datatype: "json",
            success: function (data) {
                debugger;
                $('#getCommonBackModalContent').html(data);
                $('#getCommonBackModal').modal(options);
                $('#getCommonBackModal').modal('show');

            },
            error: function () {
                alert("Get common back content load failed.");
            }
        });
    }

   

</script>