@model OCTWEB_NET45.Models.FGItemListModel
@{
    ViewBag.Title = "Stock Item List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/static/datatables/datatables.min.css" rel="stylesheet" />
<script src="~/static/datatables/datatables.min.js"></script>


<style>
   #table0 td.details-control {
        background: url('../static/img/plus-circle-solid.svg') no-repeat center center;
        background-repeat: no-repeat;
        background-size: 15px 15px;
        cursor: pointer;
        /*background:linear-gradient(to right top, #f9f8de, #eefbe3, #e4fdea, #dcfff3, #d8fffd); */
    }

   #table0 tr.details td.details-control {
        background: url('../static/img/minus-circle-solid.svg') no-repeat center center;
        background-repeat: no-repeat;
        background-size: 15px 15px;
    }
</style>

<div class="container-fluid">
    <div class="form-row">
        <div class="col">
            <!--Show dialog GetCommon Model-->
            <div id="getCommonModal" class="modal fade" role="dialog" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable " style="max-width:80%">
                    <div class="modal-content">
                        <div id="getCommonModalContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-row">
        <div class="col">
            <!--Show dialog GetCommonBack Model-->
            <div id="getCommonBackModal" class="modal fade" role="dialog" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable " style="max-width:80%">
                    <div class="modal-content">
                        <div id="getCommonBackModalContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-row">
        <div class="col">
            <div class="btn-group btn-sm shadow-sm border-0 rounded-lg mt-0 mb-3">
                <a href="@Url.Action(actionName: "HBarChart"
                            , controllerName: "FccAssy"
                            )" class="btn btn-sm btn-outline-secondary ">
                    <i class="fas fa-fan"></i> Fcc Assy Graph
                </a>
                <a href="@Url.Action(actionName: "StockMovementChart"
                            , controllerName: "FccAssy"
                            )" class="btn btn-sm btn-outline-secondary ">
                    <i class="fas fa-bacon"></i> Stock Movement Chart
                </a>
                <a href="@Url.Action(actionName: "ItemList"
                            , controllerName: "StockItems"
                            )" class="btn btn-sm btn-secondary active">
                    <i class="fas fa-list"></i> Stock Item Quantity
                </a>
            </div>
        </div>
    </div>
    @using (Html.BeginForm("ItemList", "StockItems", FormMethod.Post, new { @class = "form-horizontal", role = "form", @id = "Form1" }))
    {
        <div class="form-row">
            <div class="col-md-12 align-self-center">
                <h4 class="page-title ">Stock Item Quantity<span style="color:red;"> </span></h4>
            </div>
        </div>
        <div class="form-row">
            <div class="col">
                <p class="text-success">@ViewBag.Message</p>
                @Html.ValidationSummary(true)
            </div>
        </div>
        <div class="form-row">
            <div class="col">
                <fieldset>
                    <legend>Enter condition for search data</legend>

                    <div class="form-row ">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="mb-0">Item Short Name: </label>
                                @Html.TextBoxFor(m => m.item_short_name, new { style = "width:100%", @class = "form-control form-control-sm" })
                                @Html.ValidationMessageFor(m => m.item_short_name, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="mb-0">Item No: </label>
                                @Html.TextBoxFor(m => m.item_no, new { style = "width:100%", @class = "form-control form-control-sm" })
                                @Html.ValidationMessageFor(m => m.item_no, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="mb-0">Model No: </label>
                                @Html.TextBoxFor(m => m.model_no, new { style = "width:100%", @class = "form-control form-control-sm" })
                                @Html.ValidationMessageFor(m => m.model_no, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="mb-0">Item Name: </label>
                                @Html.TextBoxFor(m => m.item_name, new { style = "width:100%", @class = "form-control form-control-sm" })
                                @Html.ValidationMessageFor(m => m.item_name, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-4 align-self-end">
                            <div class="form-group">
                                <button type="submit" id="SearchBtn" name="SearchBtn" class="btn btn-sm btn-success" value="Search">
                                    <i class="fas fa-search"></i> Search
                                </button>
                                <input hidden="hidden" id="SearchData" name="SearchData" value="null" />
                                <!--
                                <button type="button" id="ExportCSVBtn" name="ExportCSVBtn" class="btn btn-sm btn-info">
                                    <i class="fa fa-download"></i> Export CSV
                                </button>
                                <input hidden="hidden" id="ExportCSV" name="ExportCSV" value="null" />
                                -->
                                <button id="clear" type="button" name="clear" class="btn btn-sm btn-outline-dark">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>

                            </div>
                        </div>
                    </div>

                </fieldset>
            </div>
        </div>
        <div class="form-row">
            <div class="col">
                <table class="tablecustom" id="table0" style="font-size:14px; width:100%">
                    <thead>
                        <tr>
                            <th width="3%" class="text-center"></th>
                            <th width="2%" class="text-center"></th>
                            <th width="5%" class="text-center">Detail</th>
                            <th width="10%" class="text-center">ItemNo</th>
                            <th width="15%" class="text-center">ModelNo</th>
                            <th width="15%" class="text-center">ItemShortName</th>
                            <th width="5%" class="text-center">Unit</th>
                            <th width="10%" class="text-center">StockQty</th>
                            <th width="30%" class="text-center">LocationRemark</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    }
</div>

<script language="JavaScript">
    document.getElementById("sidemenubar").style.width = "0";
    document.getElementById("main").style.marginLeft = "0";


    $("#table1 tbody tr").click(function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        }
        else {
            $(this).addClass('selected');
        }
    });

    $(document).on('select2:open', function (e) {
        const selectId = e.target.id;
        $(".select2-search__field[aria-controls='select2-" + selectId + "-results']").each(function (key, value) {
            value.focus();
        });
    });
    /*
    $(document).ready(function () {
        $("#item_short_name").select2({
            placeholder: "Select",
            allowClear: true,
            width: 'resolve'
        });
    })
    */
    $("#clear").click(function () {
        $('#item_short_name').val(null).trigger('change');
        $('#item_no').val(null).trigger('change');
        $('#model_no').val(null).trigger('change');
        $('#item_name').val(null).trigger('change');
        //$("input[type=date]").val("");

    });


    $("#SearchBtn").click(function () {
        $("#PrintData").val("");
        $("#ExportCSV").val("");
        document.forms["Form1"].submit();
    })

    $("#PrintBtn").click(function () {
        $("#PrintData").val("PrintData");
        $("#ExportCSV").val("");
        document.forms["Form1"].submit();
    })

    $("#ExportCSVBtn").click(function () {
        $("#ExportCSV").val("ExportCSV");
        $("#PrintData").val("");
        document.forms["Form1"].submit();
    })


    $(document).ready(function () {
        $("#item_short_name").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/StockItems/GetItemShortName",
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return item;
                        }))
                    }
                })
            },
            messages: {
                noResults: 'No results found.',
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            },
        });

        $("#item_no").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/StockItems/GetItemNo",
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return item;
                        }))
                    }
                })
            },
            messages: {
                noResults: 'No results found.',
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            },
        });


        $("#model_no").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/StockItems/GetModelNo",
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return item;
                        }))
                    }
                })
            },
            messages: {
                noResults: 'No results found.',
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            },
        });

        $("#item_name").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/StockItems/GetItemName",
                    type: "POST",
                    dataType: "json",
                    data: { Prefix: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return item;
                        }))
                    }
                })
            },
            messages: {
                noResults: 'No results found.',
                results: function (count) {
                    return count + (count > 1 ? ' results' : ' result ') + ' found';
                }
            },
        });

    });





    $(document).ready(function () {
        var dt = $("#table0").DataTable({
            "data": @Html.Raw(Json.Encode(Model.ItemList)),
            "columns":[
                    {
                        class: 'details-control',
                        orderable: false,
                        data: null,
                        defaultContent: '',
                        "autowidth": true,
                    },
                     { "data": "id"
                        , "render": function(data,type,row){
                            return '<div><a href="/StockItems/ExportStructure?id='+data+'"class="btn btn-sm btn-info"><i class="fas fa-download"></i><strong></strong></a></div>';
                        } 
                     },
                    { "data": "id"
                        , "render": function(data,type,row){
                            return '<div><a href="/StockItems/ItemDetail?id='+data+'"class="btn btn-sm btn-success"><i class="fas fa-list"></i> Detail</a></div>';
                        } 
                    },
                    { "data": "ItemNo", "autowidth": true },
                    { "data": "ModelNo", "autowidth": true },
                    { "data": "ItemShortName", "autowidth": true },
                    { "data": "UnitCode", "autowidth": true },
                    { "data": "StockQty_str", "autowidth": true },                   
                    { "data": "LocationRemark", "autowidth": true },

            ],
            createdRow: function(row, data, index){
                //$('td:eq(1)', row).css('background','linear-gradient(to right bottom, #95f9c5, #82f3c7, #6eedca, #59e7cd, #40e0d0)')
                //$('td', row).css('background','#B9EED2')

            },
            select: true,
            buttons: [],
            "pageLength": 20,
            "lengthMenu": [[10,20,30,50,-1],[10,20,30,50,"All"]],
            columnDefs: [ {sortable: false,targets: 0 } ,
                          {sortable: false,targets: 1 } ,
                          {targets: 6 ,className:"text-right"} ,
            ],
            order: [[ 3, 'asc' ]],
            fixedColumns: true
        })

        function getDetail(id){
            return $.ajax({
                url: "/StockItems/GetDatail",
                type: "get",
                data: { id: id},
                async: false,
            });
        }

        function format(d)
        {
            var html = "";
            var id = d.id;

            var request = getDetail(id);

            request.done(function( response ) {
                html += '<table style="font-size:12px; width:100%; ">'
                        +'<tr style="background: linear-gradient(to right top, #f9f8de, #eefbe3, #e4fdea, #dcfff3, #d8fffd);">'
                        +'<th width=2%>No.</th>'
                        +'<th width=5%>ItemNo</th>'
                        +'<th width=12%>ModelNo</th>'
                        +'<th width=12%>ItemShortName</th>'
                        +'<th width=3%>VendorCode</th>'
                        +'<th width=8%>VendorName</th>'
                        +'<th width=3%>UnitCode</th>'
                        +'<th width=5%>Max</th>'
                        +'<th width=5%>Min</th>'
                        +'<th width=5%>Avg</th>'
                        +'<th width=5%>StockQty</th>'
                        +'<th width=3%>Ratio</th>'
                        +'<th width=7%>StockQty/Ratio</th>'
                        +'<th width=7%>Common</th>'
                        +'<th width=18%>Remark</th>'
                        +'<tr>'
                for (var i = 0; i < response.length; i++) {
                    if(response[i].status === 1){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    else if(response[i].status === 2){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    else if(response[i].status === 3){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    else if(response[i].status === 4){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #d8d2cb, #e2dbcf, #ebe4d4, #f3eed9, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 5){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #b9f3e4, #caf5dd, #dcf6da, #ecf7da, #f9f8de);">';
                    }
                    else if(response[i].status === 6){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #b9f3e4, #caf5dd, #dcf6da, #ecf7da, #f9f8de);">';
                    }
                    else if(response[i].status === 7){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #b9f3e4, #caf5dd, #dcf6da, #ecf7da, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 8){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #c9f4aa, #daf4b4, #e7f5c1, #f2f6cf, #f9f8de);">';
                    }
                    else if(response[i].status === 9){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #c9f4aa, #daf4b4, #e7f5c1, #f2f6cf, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 10){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #c9f4aa, #daf4b4, #e7f5c1, #f2f6cf, #f9f8de);">';
                    }
                    else if(response[i].status === 11){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #f1f7b5, #f4f7bf, #f6f7c9, #f8f8d4, #f9f8de);">';
                    }
                    else if(response[i].status === 12){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #f1f7b5, #f4f7bf, #f6f7c9, #f8f8d4, #f9f8de);">';
                    }
                    else if(response[i].status === 15){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #f1f7b5, #f4f7bf, #f6f7c9, #f8f8d4, #f9f8de);">';
                    }
                    ///
                    else if(response[i].status === 13){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #ffd1d1, #ffdace, #ffe4cf, #fdeed5, #f9f8de);">';
                    }
                    else if(response[i].status === 14){
                        html += '<tr class="ttt" style="background: linear-gradient(to right, #ffd1d1, #ffdace, #ffe4cf, #fdeed5, #f9f8de);">';
                    }
                    else{
                        html += '<tr>';
                    }
                   
                    html += '<td>' + (i+1) + '</td>';

                    html += '<td>' + response[i].ItemNo + '</td>';

                    html += '<td>' + response[i].ModelNo + '</td>';
                    html += '<td>' + response[i].ItemShortName + '</td>';
                    html += '<td>' + response[i].VendorCode + '</td>';
                    html += '<td>' + response[i].BusinessPartnerShortName + '</td>';
                    html += '<td>' + response[i].UnitCode + '</td>';
                    html += '<td class="text-right">' + response[i].qty_max_str + '</td>';
                    html += '<td class="text-right">' + response[i].qty_min_str + '</td>';
                    html += '<td class="text-right">' + response[i].qty_avg_str + '</td>';

                    if(response[i].qty_avg >= response[i].StockQty)
                    {
                        html += '<td class="text-right" style="font-weight:bold;color:red">' + response[i].StockQty_str + '</td>';
                    }
                    else{
                        html += '<td class="text-right" style="font-weight:bold">' + response[i].StockQty_str + '</td>';
                    }

                    html += '<td class="text-right">' + response[i].Ratio + '</td>';
                    html += '<td class="text-right">' + response[i].StockQty_Ratio_str + '</td>';
                    html += '<td><span style="display:inline">'
                                +'<button type="button" class="btn btn-sm btn-warning" title="Common Backward" onclick="getCommonBack('+ response[i].Id +')" ><i class="fas fa-arrow-left"></i></button>'
                                +' <button type="button" class="btn btn-sm btn-warning" title="Common Forward" onclick="getCommon('+ response[i].Id +')" ><i class="fas fa-arrow-right"></i></button></td></span>';
                    html += '<td>' + response[i].LocationRemark + '</td>';


                    html += '</tr>';
                }
                html += '</table>'
            });

            return html;

        }

        //Array to track the ids of the details displayed rows
        var detailRows = [];
        $('#table0 tbody').on('click', 'tr td.details-control',function(){
            var tr = $(this).closest('tr');
            var row = dt.row(tr);
            var idx = detailRows.indexOf(tr.attr('id'));

            if(row.child.isShown()){
                tr.removeClass('details');
                row.child.hide();
                //Remove form the 'open' array
                detailRows.splice(idx,1);
            }else{
                tr.addClass('details');
                row.child(format(row.data())).show();
                //Add to the 'open' array
                if(idx === -1){
                    detailRows.push(tr.attr('id'));
                }
            }
        })

        //On each draw, loop over ther 'detailRows' array and show any
        dt.on('draw', function(){
            detailRows.forEach(function(id,i){
                $('#'+ id + 'td.details-control').trigger('click');
            });

        });

    });

    function getCommon(id)
    {
        debugger;
        //var $buttonClicked = $(this);
        var id = id;//$buttonClicked.attr('data-id');
        var options = { "backdrop": "static", keyboard: true };
        $.ajax({
            type: "GET",
            url: "/StockItems/GetCommon",
            contentType: "application/json; charset=utf-8",
            data: { "id": id },
            datatype: "json",
            success: function (data) {
                debugger;
                $('#getCommonModalContent').html(data);
                $('#getCommonModal').modal(options);
                $('#getCommonModal').modal('show');

            },
            error: function () {
                alert("Get common content load failed.");
            }
        });
    }

    function getCommonBack(id)
    {
        debugger;
        //var $buttonClicked = $(this);
        var id = id;//$buttonClicked.attr('data-id');
        var options = { "backdrop": "static", keyboard: true };
        $.ajax({
            type: "GET",
            url: "/StockItems/GetCommonBack",
            contentType: "application/json; charset=utf-8",
            data: { "id": id },
            datatype: "json",
            success: function (data) {
                debugger;
                $('#getCommonBackModalContent').html(data);
                $('#getCommonBackModal').modal(options);
                $('#getCommonBackModal').modal('show');

            },
            error: function () {
                alert("Get common back content load failed.");
            }
        });
    }

    /*
    $(function () {
        $("getCommon").click(function () {
            alert(123);
            debugger;
            var $buttonClicked = $(this);
            var id = $buttonClicked.attr('data-id');
            var options = { "backdrop": "static", keyboard: true };
            $.ajax({
                type: "GET",
                url: "/StockItems/GetCommon",
                contentType: "application/json; charset=utf-8",
                data: { "id": id },
                datatype: "json",
                success: function (data) {
                    debugger;
                    $('#getCommonModalContent').html(data);
                    $('#getCommonModal').modal(options);
                    $('#getCommonModal').modal('show');

                },
                error: function () {
                    alert("Get common content load failed.");
                }
            });
        });
        //$("#closebtn").on('click',function(){
        //    $('#getCommonModal').modal('hide');

        $("#closbtn").click(function () {
            $('#getCommonModal').modal('hide');
        });
    });
    */




</script>