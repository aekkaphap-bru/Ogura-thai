@model OCTWEB_NET45.Models.LeaveModel

@{
    ViewBag.Title = "CreateLeaveReport";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@*<h2>CreateLeaveReport</h2>*@

<style>
    .tableleave {
        border-collapse: collapse;
        width: 100%;
        margin: 25px 0;
        font-size: 1em;
        /*font-family: sans-serif;*/
        /* min-width: 400px;*/
        box-shadow: 0 0 20px rgb(128, 128, 128);
    }

        .tableleave th, .tableleave td {
            padding: 5px 5px;
            text-justify: distribute;
            vertical-align: middle;
            border: 1px solid black;
            border-bottom: 1px solid black;
            border-right: 1px solid black;
        }
</style>

<div class="container-fluid">
    <div class="row">
        <a href="/Leave/LeaveList" class="btn-outline-secondary">Leave List <i class="fa fa-angle-right"></i> </a>&nbsp;
    </div>

    @using (Html.BeginForm("CreateLeaveReport", "LeaveReport", FormMethod.Post, new { @class = "form-horizontal", role = "form", @id = "Form1", enctype = "multipart/form-data" }))
    {
        <div class="row">
            <div class="col">
                @Html.HiddenFor(m => m.emp_profile)
            </div>
        </div>
        <div class="row">
            <div class="container">
                <div class="card shadow-lg border-0 rounded-lg mt-0 mb-3">
                    <div class="card-header justify-content-center">
                        <p class="text-danger">@ViewBag.ErrorMessage</p>
                        <p class="text-success">@ViewBag.Message</p>
                        @Html.ValidationSummary("", new { @class = "text-danger" })
                        <h4 class="font-weight-bolder my-1 text-center">SEARCH EMPLOYEE (ค้นหาข้อมูลพนักงาน)</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-row justify-content-center">
                            <div class="col-md-4 text-left">
                                <div class="form-group">
                                    <label class="mb-0">Emp ID:<span style="color:red;">*</span> </label>
                                    @Html.TextBoxFor(m => m.emp_id, new { @class = "form-control form-control-sm" })
                                    <p class="text-danger">@Html.ValidationMessageFor(m => m.emp_id)</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group text-center">
                                    <div class="image-upload">
                                        <label for="imgfile">
                                            <img class="img-profile border-0 rounded-lg" id="emp_pic" src="@Model.emp_profile" height="100" width="100" />
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group text-right">

                                </div>
                            </div>
                        </div>
                        <div class="form-row justify-content-center">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">First Name(EN): </label>
                                    @Html.TextBoxFor(m => m.fname, new { @class = "form-control form-control-sm", @readonly = "true" })

                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Last Name(EN): </label>
                                    @Html.TextBoxFor(m => m.lname, new { @class = "form-control form-control-sm", @readonly = "true" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Nick Name(EN): </label>
                                    @Html.TextBoxFor(m => m.nickname, new { @class = "form-control form-control-sm", @readonly = "true" })
                                </div>
                            </div>
                        </div>
                        <div class="form-row justify-content-center">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Department: </label>
                                    @Html.TextBoxFor(m => m.department, new { @class = "form-control form-control-sm", @readonly = "true" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Position: </label>
                                    @Html.TextBoxFor(m => m.position, new { @class = "form-control form-control-sm", @readonly = "true" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Cost Center: </label>
                                    @Html.TextBoxFor(m => m.costcenter, new { @class = "form-control form-control-sm", @readonly = "true" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="container">
                <div class="card shadow-lg border-0 rounded-lg mt-0 mb-3">
                    <div class="card-header justify-content-center">
                        <h4 class="font-weight-bolder my-1 text-center">ADD LEAVE REQUEST (เพิ่มข้อมูลการลางาน) </h4>
                    </div>
                    <div class="card-body">

                        <div class="form-row justify-content-center">
                            <div class="col-md-4 align-self-center">
                                <div class="form-group">
                                    <label class="mb-0">Date:<span style="color:red;">*</span> </label><br />
                                    <label class="mb-0">(วันที่ยื่นใบลา) </label>
                                    <input type="date" id="create_date" name="create_date" class="form-control form-control-sm " value="@Model.create_date.ToString("yyyy-MM-dd")" />
                                    @Html.ValidationMessageFor(m => m.create_date, "", new { @class = "text-danger" })
                                    <br />
                                </div>
                            </div>
                            <div class="col-md-2 align-self-center">
                                <div class="form-group">
                                    <label class="mb-0">Shift (กะการทำงาน): </label>
                                    <br />
                                    @Html.RadioButtonFor(m => m.shift, "Day") <span>Day</span>
                                    @Html.RadioButtonFor(m => m.shift, "Night") <span>Night</span>

                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <table class="tableleave" style="font-size: 12px;">
                                        <tbody>
                                            <tr>
                                                <td>
                                                    30min	=	0.06	Day
                                                </td>
                                                <td>
                                                    3hr	=	0.38	Day
                                                </td>
                                                <td>
                                                    5.5hr	=	0.69	Day
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    1hr	=	0.13	Day
                                                </td>
                                                <td>
                                                    <span style=" text-justify: distribute"> 3.5hr	=	0.44	Day </span>
                                                </td>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 6hr	=	0.75	Day </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 1.5hr	=	0.19	Day </span>
                                                </td>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 4hr	=	0.50	Day </span>
                                                </td>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 6.5hr	=	0.81	Day </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 2hr	=	0.25	Day </span>
                                                </td>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 4.5hr	=	0.56	Day	</span>
                                                </td>
                                                <td>
                                                    <span style="text-align:justify;text-justify:distribute"> 7hr	=	0.88	Day </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 2.5hr	=	0.31	Day </span>
                                                </td>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 5hr	=	0.63	Day </span>
                                                </td>
                                                <td>
                                                    <span style="text-align: justify; text-justify: distribute"> 7.5hr	=	0.94	Day </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                        <div class="form-row justify-content-center">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Start Date:<span style="color:red;">*</span> </label><br />
                                    <label class="mb-0">(วันที่เริ่มลา)</label>
                                    <!--{
                                        string start_date = Model.start_date.HasValue ? Model.start_date.Value.ToString("yyyy-MM-dd HH:mm") : "";
                                    }-->
                                    <input type="datetime-local" id="start_date" name="start_date" class="form-control form-control-sm" value="@Model.start_date.ToString("yyyy-MM-dd HH:mm")" />
                                    @Html.ValidationMessageFor(m => m.start_date, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">End Date:<span style="color:red;">*</span> </label><br />
                                    <label class="mb-0">(วันที่สิ้นสุดการลา) </label>
                                    <!--{
                                        string end_date = Model.end_date.HasValue ? Model.end_date.Value.ToString("yyyy-MM-dd HH:mm") : "";
                                    }-->
                                    <input type="datetime-local" id="end_date" name="end_date" class="form-control form-control-sm" value="@Model.end_date.ToString("yyyy-MM-dd HH:mm")" />
                                    @Html.ValidationMessageFor(m => m.end_date, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Total Day:<span style="color:red;">*</span> </label><br />
                                    <label class="mb-0">(จำนวนวันทั้งหมด)</label>
                                    @Html.TextBoxFor(m => m.totalday, new { @class = "form-control form-control-sm" })
                                    @Html.ValidationMessageFor(m => m.totalday, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                        <div class="form-row justify-content-center">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Type Leave:<span style="color:red;">*</span> </label><br />
                                    <label class="mb-0">(ประเภทการลางาน) </label>
                                    @Html.DropDownList("typeleave_id", Model.SelectTypeLeave, "", new { @class = "form-control form-control-sm", style = "width:100%" })
                                    @Html.ValidationMessageFor(m => m.typeleave_id, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Reasons For Leave: </label><br />
                                    <label class="mb-0">(เหตุผลการลางาน)</label>
                                    @Html.DropDownList("reasonleave", Model.SelectReasonLeave, "", new { @class = "form-control form-control-sm", style = "width:100%" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="mb-0">Reasons For Leave:<span style="color:red;">*</span> </label><br />
                                    <label class="mb-0">(เหตุผลการลางาน) </label>
                                    @Html.TextAreaFor(m => m.reason_detail, new { @class = "form-control form-control-sm" })
                                    @Html.ValidationMessageFor(m => m.reason_detail, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                        <div class="form-row justify-content-center">
                            <div class="col">
                                <fieldset>
                                    <legend>Leave Request (ผลคำร้องขอการลางาน)</legend>
                                    <div class="form-row justify-content-center">

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                @Html.RadioButtonFor(m => m.approved, "Approved") <label><span> Approved (ได้รับการอนุมัติ) </span></label>
                                                <br />
                                                @Html.RadioButtonFor(m => m.approved, "Not Approved") <label><span> Not Approved (ไม่ได้รับการอนุมัติ)</span></label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="mb-0">Reason Not Approved (เหตุผลที่ไม่อนุมัติ): </label>
                                                @Html.TextAreaFor(m => m.reason_not_approved, new { @class = "form-control form-control-sm", @readonly = "true" })
                                            </div>
                                        </div>
                                    </div>

                                </fieldset>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col">
                <div class="form-row justify-content-center">
                    <button type="submit" class="btn btn-primary" value="Save">
                        <i class="fas fa-save"></i> Save
                    </button>
                    &nbsp;
                    <button type="button" onclick="history.back()" name="Cancel" class="btn btn-outline-primary">
                        <i class="fa fa-ban" aria-hidden="true"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    }
</div>



<script language="JavaScript">

    $(document).on('select2:open', function (e) {
        const selectId = e.target.id;
        $(".select2-search__field[aria-controls='select2-" + selectId + "-results']").each(function (key, value) {
            value.focus();
        });
    });

    $(document).ready(function () {
        /*
        $("#reasonleave").select2({
            placeholder: "select ",
            allowClear: true,
            width: 'resolve'
        });
        $("#typeleave_id").select2({
            placeholder: "select ",
            allowClear: true,
            width: 'resolve'
        });
        */
        //Radio Approved change
        if ($("[name=approved]:checked").val() == "Not Approved") {
            $("#reason_not_approved").removeAttr("readonly");
        }
        else {
            $("#reason_not_approved").attr("readonly", true);
        }
        //Radio Shift change
        if ($("[name=shift]:checked").val() == "Day") {
            //  alert($("[name=shift]:checked").val());
        }
        else {
            //  alert($("[name=shift]:checked").val());
        }

    });
    
    //Dropdown Select Reason Change
    $("#reasonleave").change(function () {
        var reason = $("#reasonleave").val();
        document.getElementById("reason_detail").value = reason;
    });
    
    //Radio Approved change
    $("[name=approved]").click(function () {
        if ($("[name=approved]:checked").val() == "Not Approved") {
            $("#reason_not_approved").removeAttr("readonly");
        }
        else {
            $("#reason_not_approved").attr("readonly", true);
        }
    });
    
    //Radio Shift change
    $("[name=shift]").click(function () {

        var d = new Date();
        var month = zeroPadded(d.getMonth() + 1);
        var year = d.getFullYear();
        var day = zeroPadded(d.getDate());
        var date_str = year + "-" + month + "-" + day

        var d1 = new Date();
        d1.setDate(d1.getDate() + 1);
        var month_1 = zeroPadded(d1.getMonth() + 1);
        var year_1 = d1.getFullYear();
        var day_1 = zeroPadded(d1.getDate());
        var date_str_1 = year_1 + "-" + month_1 + "-" + day_1

        if ($("[name=shift]:checked").val() == "Day") {
            $("#start_date").val(date_str + " 08:00");
            $("#end_date").val(date_str + " 17:40");
        }
        if ($("[name=shift]:checked").val() == "Night") {
            $("#start_date").val(date_str + " 20:00");
            $("#end_date").val(date_str + " 05:40");
        }
    });
    
    function zeroPadded(val) {
        if (val >= 10)
            return val;
        else
            return '0' + val;
    }

    //$("#end_date").change(function () {
    //    var startDate = document.getElementById("start_date").value;
    //    var endDate = document.getElementById("end_date").value;

    //    if ((Date.parse(endDate) <= Date.parse(startDate))) {
    //        alert("End date should be greater than Start date");
    //        //document.getElementById("todate").value = startDate;
    //    }
    //});

    //$("#start_date").change(function () {
    //    var startDate = document.getElementById("start_date").value;
    //    var endDate = document.getElementById("end_date").value;

    //    if ((Date.parse(endDate) <= Date.parse(startDate))) {
    //        //alert("End date should be greater than Start date");
    //        //document.getElementById("todate").value = startDate;
    //    }
    //});

    $(function () {

        $('#typeleave_id').on("change", function () {
            var id = $('#typeleave_id').val();
            var obj = { id: id };
            AjaxCall('/Leave/GetReasonLeave', JSON.stringify(obj), 'POST').done(function (response) {
                if (response.length > 0) {
                    $('#reasonleave').html('');
                    var options = '';
                    options += '<option value="Select">Select Reason Leave</option>';
                    for (var i = 0; i < response.length; i++) {
                        options += '<option value="' + response[i].val + '">' + response[i].label + '</option>';
                    }
                    $('#reasonleave').append(options);
                }
                else {
                    $('#reasonleave').html('');
                }
            }).fail(function (error) {
                //alert(error.StatusText);
                $('#reasonleave').html('');
            });
        });

        $('input[name=emp_id]').on("keyup", function () {
            var emp_id = $(this).val();
            var obj = { emp_id: emp_id };
            AjaxCall('/Leave/GetEmpDetail', JSON.stringify(obj), 'POST').done(function (response) {

                var pic = response["pic"];
                var empid = response["empid"];
                var fname = response["fname"];
                var lname = response["lname"];
                var nickname = response["nickname"];
                var department = response["department"];
                var position = response["position"];
                var costcenter = response["costcenter"];

                if (pic != null) {
                    $('#emp_pic').attr("src", pic);
                    $('#emp_profile').val(pic);
                }
                else {
                    var nopic = $('#emp_profile').val();
                    $('#emp_pic').attr("src", nopic);
                }

                $('#fname').val(fname);
                $('#lname').val(lname);
                $('#nickname').val(nickname);
                $('#department').val(department);
                $('#position').val(position);
                $('#costcenter').val(costcenter);

            }).fail(function (error) {
                //alert(error.StatusText);
            });
        });
    });

    function AjaxCall(url, data, type) {
        return $.ajax({
            url: url,
            type: type ? type : 'GET',
            data: data,
            contentType: 'application/json'
        });
    }
</script>